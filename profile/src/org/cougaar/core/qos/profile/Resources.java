package org.cougaar.core.qos.profile;

import java.text.DecimalFormat;

import org.cougaar.core.mts.MessageAddress;
import org.cougaar.core.node.NodeIdentificationService;
import org.cougaar.core.qos.metrics.Metric;
import org.cougaar.core.qos.metrics.MetricsService;

/**
 * This component profiles the {@link MetricsService}'s
 * summary resource metrics (load average, tcp use, etc).
 * <p> 
 * This is the same output as the "/metrics/resources" servlet
 * generated by {@link org.cougaar.core.qos.metrics.NodeResourcesServlet}.
 * <p>
 * Example output:<pre> 
 *   resources - #EffectiveMJips, LoadAverage, Count, Jips, BogoMips,
 *     Cache, TcpInUse, UdpInUse, TotalMemory, FreeMemory,
 *     MeanTimeBetweenFailure,
 *   resources - 1947, 2.67, 1, 1947156330, 5570,
 *     512, 37, 8, 2064548, 121492,
 *     8760,
 * </pre>
 *
 * @see ProfilerCoordinator required coordinator component
 */ 
public class Resources extends ProfilerBase {
  private static final DecimalFormat FORMAT_DECIMAL = new DecimalFormat("#0.00");
  private static final String[] FIELDS = new String[] {
    "EffectiveMJips",
    "LoadAverage",
    "Count",
    "Jips",
    "BogoMips",
    "Cache",
    "TcpInUse",
    "UdpInUse",
    "TotalMemory",
    "FreeMemory",
    "MeanTimeBetweenFailure",
  };
  private static final String HEADER = toHeader(FIELDS);

  private MetricsService ms;
  private MessageAddress nodeId;
  @Override
public void load() {
    super.load();
    ms = sb.getService(this, MetricsService.class, null);
    NodeIdentificationService nis = sb.getService(this, NodeIdentificationService.class, null);
    nodeId = nis.getMessageAddress();
    sb.releaseService(this, NodeIdentificationService.class, nis);
  }
  @Override
public void run() {
    log("org.cougaar.core.qos.profile.resources",
        HEADER, getResources());
  }
  private String getResources() {
    StringBuffer buf = new StringBuffer();
    for (int i = 0; i < FIELDS.length; i++) {
      buf.append(getMetric(FIELDS[i])).append(", ");
    }
    return buf.toString();
  }

  private String getMetric(String name) {
    Metric metric = ms.getValue("Agent("+nodeId+"):"+name);
    if (metric == null) {
      return "-1";
    }
    if (name.equals("LoadAverage")) {
      return FORMAT_DECIMAL.format(metric.doubleValue());
    }
    return Integer.toString((int) metric.doubleValue());
  }
}
